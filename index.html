<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuždarytų Sutarčių Suvestinė</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f3f4f6; 
            color: #1f2f37; 
            font-family: 'Inter', sans-serif;
        }
        .main-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .form-input, .form-select {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            color: #1f2f37;
        }
        .form-input:focus, .form-select:focus {
            --tw-ring-color: #2563eb;
            border-color: #2563eb;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }
        .summary-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .summary-row:last-child {
            border-bottom: none;
        }
        .summary-label {
            color: #4b5563;
        }
        .summary-value {
            font-weight: 600;
            font-family: 'mono', monospace;
            text-align: right;
        }
        .summary-total {
            font-weight: 700;
            font-size: 1.125rem;
            border-top: 2px solid #d1d5db;
            margin-top: 0.75rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        <!-- Antraštė -->
        <header class="mb-8 text-center">
            <div id="timestamp" class="text-sm text-gray-500 font-semibold mb-2"></div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Neuždarytų Pirkimo ir Pardavimo sutarčių SUVESTINĖ <br class="md:hidden"><span class="font-normal text-2xl">(Pelningumo prognozė)</span></h1>
        </header>

        <!-- Filtrai -->
        <div class="mb-8 p-6 main-card rounded-xl">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="grain-select" class="block text-sm font-medium text-gray-700 mb-2">Kultūra</label>
                    <select id="grain-select" class="form-select w-full rounded-md shadow-sm"></select>
                </div>
                <div>
                    <label for="period-select" class="block text-sm font-medium text-gray-700 mb-2">Laikotarpis</label>
                    <select id="period-select" class="form-select w-full rounded-md shadow-sm">
                        <option value="visas">Visas laikotarpis</option>
                        <option value="pasirinkti">Pasirinkti datas</option>
                    </select>
                </div>
                <div id="date-range-picker" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">Nuo</label>
                        <input type="date" id="start-date" class="form-input w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">Iki</label>
                        <input type="date" id="end-date" class="form-input w-full rounded-md shadow-sm">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rinkos Indeksai -->
        <div class="mb-8 p-6 main-card rounded-xl">
             <h2 class="section-title mb-4">Rinkos Indeksai</h2>
             <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                 <div>
                    <label for="market-date" class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                    <input type="date" id="market-date" class="form-input w-full rounded-md shadow-sm">
                 </div>
                 <div>
                    <label for="matif-rapeseed" class="block text-sm font-medium text-gray-700 mb-2">Matif Rapsai (€/t)</label>
                    <input type="text" inputmode="decimal" id="matif-rapeseed" class="form-input w-full rounded-md shadow-sm">
                </div>
                <div>
                    <label for="matif-wheat" class="block text-sm font-medium text-gray-700 mb-2">Matif Kviečiai (€/t)</label>
                    <input type="text" inputmode="decimal" id="matif-wheat" class="form-input w-full rounded-md shadow-sm">
                </div>
                 <div>
                    <label for="fob-malt" class="block text-sm font-medium text-gray-700 mb-2">FOB Salyklas (€/t)</label>
                    <input type="text" inputmode="decimal" id="fob-malt" class="form-input w-full rounded-md shadow-sm">
                </div>
             </div>
        </div>

        <!-- Pirkimai -->
        <div class="mb-8 p-6 main-card rounded-xl">
            <h2 class="section-title mb-6">Pirkimai</h2>
            <div class="grid grid-cols-1 gap-6">
                <!-- Nupirktas Kiekis (Parduota dalis) -->
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-gray-800 mb-4">NUPIRKTAS KIEKIS, T. <span class="font-normal text-green-600">(PARDUOTA)</span></h3>
                    <div class="space-y-3 text-sm">
                         <div class="grid grid-cols-4 gap-4 text-xs text-gray-500 font-semibold">
                            <span class="col-span-1">Tipas</span>
                            <span class="text-right">Savikaina</span>
                            <span class="text-right">Kiekis</span>
                            <span class="text-right">Savikainos Suma</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <span class="text-gray-600">Fiksuota kaina:</span>
                            <span id="cogs-fixed-price" class="text-right font-mono">€0</span>
                            <span id="cogs-fixed-qty" class="text-right font-mono">0 t</span>
                            <span id="cogs-fixed-total" class="font-bold text-right font-mono">€0</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <span class="text-gray-600">Nefiksuota kaina:</span>
                            <span id="cogs-unfixed-price" class="text-right font-mono">€0</span>
                            <span id="cogs-unfixed-qty" class="text-right font-mono">0 t</span>
                            <span id="cogs-unfixed-total" class="font-bold text-right font-mono">€0</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center pt-3 border-t mt-3">
                            <span class="font-bold text-gray-700">Viso:</span>
                            <span id="cogs-total-price" class="text-right font-mono font-bold text-base">€0</span>
                            <span id="cogs-total-qty" class="text-right font-mono font-bold text-base">0 t</span>
                            <span id="cogs-total-sum" class="text-right font-mono font-bold text-base">€0</span>
                        </div>
                    </div>
                </div>
                 <!-- Nupirktas Kiekis (Neparduota dalis) -->
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-gray-800 mb-4">NUPIRKTAS KIEKIS, T. <span class="font-normal text-red-600">(NEPARDUOTAS)</span></h3>
                    <div class="space-y-3 text-sm">
                         <div class="grid grid-cols-4 gap-4 text-xs text-gray-500 font-semibold">
                            <span class="col-span-1">Tipas</span>
                            <span class="text-right">Savikaina</span>
                            <span class="text-right">Kiekis</span>
                            <span class="text-right">Savikainos Suma</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <span class="text-gray-600">Fiksuota kaina:</span>
                            <span id="open-fixed-price" class="text-right font-mono">€0</span>
                            <span id="open-fixed-qty" class="text-right font-mono">0 t</span>
                            <span id="open-fixed-total" class="font-bold text-right font-mono">€0</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <span class="text-gray-600">Nefiksuota kaina:</span>
                            <span id="open-unfixed-price" class="text-right font-mono">€0</span>
                            <span id="open-unfixed-qty" class="text-right font-mono">0 t</span>
                            <span id="open-unfixed-total" class="font-bold text-right font-mono">€0</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center pt-3 border-t mt-3">
                            <span class="font-bold text-gray-700">Viso:</span>
                            <span id="details-open-price" class="text-right font-mono font-bold text-base">€0</span>
                            <span id="details-open-qty" class="text-right font-mono font-bold text-base">0 t</span>
                            <span id="details-open-total" class="text-right font-mono font-bold text-base">€0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pardavimai -->
        <div class="mb-8 p-6 main-card rounded-xl">
            <h2 class="section-title mb-6">Pardavimai</h2>
            <div class="grid grid-cols-1 gap-6">
                 <!-- Parduotas Kiekis -->
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-gray-800 mb-4">PARDUOTAS KIEKIS, T. <span class="font-normal text-red-600">(PASIRAŠYTOS SUTARTYS)</span></h3>
                     <div class="space-y-3 text-sm">
                         <div class="grid grid-cols-4 gap-4 text-xs text-gray-500 font-semibold">
                            <span class="col-span-1">Tipas</span>
                            <span class="text-right">Kaina</span>
                            <span class="text-right">Kiekis</span>
                            <span class="text-right">Suma</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <span class="text-gray-600">Fiksuota kaina:</span>
                            <span id="sell-fixed-price" class="text-right font-mono">€0</span>
                            <span id="sell-fixed-qty" class="text-right font-mono">0 t</span>
                            <span id="sell-fixed-total" class="font-bold text-right font-mono">€0</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <span class="text-gray-600">Nefiksuota kaina:</span>
                            <span id="sell-unfixed-price" class="text-right font-mono">€0</span>
                            <span id="sell-unfixed-qty" class="text-right font-mono">0 t</span>
                            <span id="sell-unfixed-total" class="font-bold text-right font-mono">€0</span>
                        </div>
                        <div class="grid grid-cols-4 gap-4 items-center pt-3 border-t mt-3">
                            <span class="font-bold text-gray-700">Viso:</span>
                            <span id="details-sell-price" class="text-right font-mono font-bold text-base">€0</span>
                            <span id="details-sell-qty" class="text-right font-mono font-bold text-base">0 t</span>
                            <span id="details-sell-total" class="text-right font-mono font-bold text-base">€0</span>
                        </div>
                    </div>
                </div>

                <!-- Faktinė Būsena -->
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-semibold text-gray-700 mb-4">Faktinė Būsena (pagal jau įvykdytus sandorius)</h3>
                    <div class="summary-row">
                        <span class="summary-label">Kiekis (parduota)</span>
                        <span id="summary-sold-qty" class="summary-value">0 t</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Pajamos (faktinės)</span>
                        <span id="summary-actual-income" class="summary-value text-green-600">+ €0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Savikaina (parduota)</span>
                        <span id="summary-actual-cogs" class="summary-value text-red-600">- €0</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span class="summary-label">Pelnas / Nuostolis (faktinis)</span>
                        <span id="summary-actual-profit" class="summary-value text-lg">€0</span>
                    </div>
                </div>

                 <!-- Prognozė -->
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-semibold text-gray-700 mb-4">Prognozė (neparduotam kiekiui)</h3>
                    <div class="summary-row">
                        <span class="summary-label">Kiekis (neparduota)</span>
                        <span id="summary-open-qty" class="summary-value">0 t</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-center pt-4">
                         <div>
                            <label for="projected-sell-price" class="block text-sm font-medium text-gray-700 mb-1">Jeigu parduotume po (€/t): <span class="text-red-600 font-normal">(įrašyti kainos sumą)</span></label>
                            <input type="text" inputmode="decimal" id="projected-sell-price" class="form-input w-full rounded-md shadow-sm">
                        </div>
                        <div></div>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Prognozuojamos pajamos</span>
                        <span id="projected-income" class="summary-value text-green-600">+ €0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Savikaina (neparduota)</span>
                        <span id="projected-cogs" class="summary-value text-red-600">- €0</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span class="summary-label">Pelnas / Nuostolis (prognozuojamas)</span>
                        <span id="projected-profit" class="summary-value text-lg">€0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Apibendrinta Ataskaita -->
        <div class="space-y-8">
            <h2 class="section-title mb-4">Apibendrinimas</h2>
            
            <!-- Bendra Prognozė -->
            <div class="p-6 main-card rounded-xl bg-amber-900 text-white">
                <h3 class="font-semibold text-amber-100 mb-4">1. Bendra Prognozė (Faktas + Prognozė)</h3>
                <div class="summary-row border-amber-700">
                    <span class="summary-label text-amber-200">Faktinis pelnas / nuostolis</span>
                    <span id="total-summary-actual-profit" class="summary-value text-amber-100">€0</span>
                </div>
                <div class="summary-row border-amber-700">
                    <span class="summary-label text-amber-200">Prognozuojamas pelnas / nuostolis (už likutį)</span>
                    <span id="total-summary-projected-profit" class="summary-value text-amber-100">€0</span>
                </div>
                <div class="summary-row summary-total border-amber-600">
                    <span class="summary-label text-lg text-amber-100">Bendras Prognozuojamas Pelnas / Nuostolis</span>
                    <span id="total-projected-profit" class="summary-value text-2xl">€0</span>
                </div>
            </div>

            <!-- Vidutiniai Rodikliai -->
            <div class="p-6 main-card rounded-xl">
                <h3 class="font-semibold text-gray-700 mb-4">2. Prognozės Vidurkiai</h3>
                <div class="summary-row">
                    <span class="summary-label">Vidutinė pirkimo kaina (€/t)</span>
                    <span id="summary-avg-buy-price" class="summary-value text-lg">€0,00</span>
                </div>
                 <div class="summary-row">
                    <span class="summary-label">Vidutinė faktinių pardavimų kaina (€/t)</span>
                    <span id="summary-avg-actual-sell-price" class="summary-value text-lg">€0,00</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label font-semibold">Vidutinis faktinis pelnas / nuostolis (€/t)</span>
                    <span id="summary-actual-profit-per-ton" class="summary-value text-lg font-semibold">€0,00</span>
                </div>
                 <div class="summary-row">
                    <span class="summary-label font-semibold">Vidutinis prognozuojamas pelnas / nuostolis (€/t)</span>
                    <span id="summary-projected-profit-per-ton" class="summary-value text-lg font-semibold">€0,00</span>
                </div>
                <div class="summary-row summary-total">
                    <span class="summary-label font-bold">Vidutinis bendras pelnas / nuostolis (€/t)</span>
                    <span id="summary-total-profit-per-ton" class="summary-value text-xl font-bold">€0,00</span>
                </div>
            </div>

        </div>

    </div>

<script>
    // --- DUOMENŲ BAZĖS SIMULIACIJA ---
    const allData = {
        'salykliniai_mieziai': {
            name: 'Salykliniai miežiai',
            transactions: [
                { date: '2025-09-15', type: 'purchase', tonnes: 13000, value: 2574000 },
                { date: '2025-11-20', type: 'purchase', tonnes: 13000, value: 2574000 },
                { date: '2026-01-25', type: 'purchase', tonnes: 12450, value: 2490000 },
                { date: '2026-03-18', type: 'purchase', tonnes: 12450, value: 2490560 },
                { date: '2025-10-05', type: 'sale', tonnes: 9750, value: 2135250 },
                { date: '2025-12-10', type: 'sale', tonnes: 9750, value: 2135250 },
                { date: '2026-02-15', type: 'sale', tonnes: 9700, value: 2133492 },
                { date: '2026-04-20', type: 'sale', tonnes: 9700, value: 2133492 }
            ]
        },
        'mieziai': { 
            name: 'Miežiai', 
            transactions: [
                { date: '2025-08-20', type: 'purchase', tonnes: 50000, value: 9500000 },
                { date: '2025-10-15', type: 'sale', tonnes: 43000, value: 8600000 }
            ]
        },
        'kvieciai': { 
            name: 'Kviečiai',
             transactions: [
                { date: '2025-09-01', type: 'purchase', tonnes: 85000, value: 16150000 },
                { date: '2025-11-01', type: 'sale', tonnes: 72000, value: 15120000 }
            ]
        },
        'salyklas': { 
            name: 'Salyklas',
            transactions: [
                { date: '2025-09-10', type: 'purchase', tonnes: 11000, value: 4950000 },
                { date: '2025-12-01', type: 'sale', tonnes: 9500, value: 4560000 }
            ]
        },
        'rapsai': { 
            name: 'Rapsai',
            transactions: [
                { date: '2025-07-25', type: 'purchase', tonnes: 25000, value: 11250000 },
                { date: '2025-09-25', type: 'sale', tonnes: 26000, value: 12220000 }
            ]
        }
    };

    // --- APLIKACIJOS BŪSENA (STATE) ---
    const state = { selectedGrain: 'salykliniai_mieziai', selectedPeriod: 'visas' };
    
    // --- PAGALBINĖS FUNKCIJOS ---
     const formatCurrency = (val, sign) => {
        const prefix = sign && val > 0 ? '+' : (sign && val < 0 ? '-' : '');
        const formattedVal = new Intl.NumberFormat('lt-LT', { style: 'currency', currency: 'EUR' }).format(Math.abs(val));
        return `${prefix} ${formattedVal}`;
    };
    const formatCurrencyPerTon = (val) => {
        return new Intl.NumberFormat('lt-LT', { 
            style: 'currency', 
            currency: 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(val);
    };
    const formatTonnes = (val) => `${new Intl.NumberFormat('lt-LT').format(Math.round(val))} t`;

    function getFilteredData() {
        const grainData = allData[state.selectedGrain];
        const periodSelection = document.getElementById('period-select').value;
        
        let transactionsToProcess = grainData.transactions;

        if (periodSelection === 'pasirinkti') {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (startDate && endDate) {
                transactionsToProcess = grainData.transactions.filter(t => t.date >= startDate && t.date <= endDate);
            }
        }

        const result = { totalPurchasedTonnes: 0, totalPurchaseValue: 0, totalSoldTonnes: 0, totalSoldValue: 0 };
        transactionsToProcess.forEach(t => {
            if (t.type === 'purchase') {
                result.totalPurchasedTonnes += t.tonnes;
                result.totalPurchaseValue += t.value;
            } else if (t.type === 'sale') {
                result.totalSoldTonnes += t.tonnes;
                result.totalSoldValue += t.value;
            }
        });
        return result;
    }

    // --- RENDERINIMO FUNKCIJOS ---
    function renderDashboard() {
        state.selectedGrain = document.getElementById('grain-select').value;
        
        const data = getFilteredData();
        const openPosition = data.totalPurchasedTonnes - data.totalSoldTonnes;
        const avgBuyPrice = data.totalPurchasedTonnes > 0 ? data.totalPurchaseValue / data.totalPurchasedTonnes : 0;
        const avgSellPrice = data.totalSoldTonnes > 0 ? data.totalSoldValue / data.totalSoldTonnes : 0;

        const fixedRatio = 0.4;
        const priceAdjustment = 2;
        
        const costOfGoodsSold = data.totalSoldTonnes * avgBuyPrice;
        const cogsFixedTonnes = data.totalSoldTonnes * fixedRatio;
        const cogsUnfixedTonnes = data.totalSoldTonnes * (1 - fixedRatio);
        const cogsFixedPrice = avgBuyPrice - priceAdjustment;
        const cogsFixedValue = cogsFixedTonnes * cogsFixedPrice;
        const cogsUnfixedValue = costOfGoodsSold - cogsFixedValue;
        const cogsUnfixedPrice = cogsUnfixedTonnes > 0 ? cogsUnfixedValue / cogsUnfixedTonnes : 0;

        const openPositionCost = openPosition * avgBuyPrice;
        const fixedOpenTonnes = openPosition * fixedRatio;
        const unfixedOpenTonnes = openPosition * (1 - fixedRatio);
        const fixedOpenPrice = avgBuyPrice - priceAdjustment;
        const fixedOpenValue = fixedOpenTonnes * fixedOpenPrice;
        const unfixedOpenValue = openPositionCost - fixedOpenValue;
        const unfixedOpenPrice = unfixedOpenTonnes > 0 ? unfixedOpenValue / unfixedOpenTonnes : 0;
        
        const fixedSoldTonnes = data.totalSoldTonnes * fixedRatio;
        const unfixedSoldTonnes = data.totalSoldTonnes * (1 - fixedRatio);
        const fixedSellPrice = avgSellPrice - priceAdjustment;
        const fixedSoldValue = fixedSoldTonnes * fixedSellPrice;
        const unfixedSoldValue = data.totalSoldValue - fixedSoldValue;
        const unfixedSellPrice = unfixedSoldTonnes > 0 ? unfixedSoldValue / unfixedSoldTonnes : 0;

        document.getElementById('cogs-fixed-price').textContent = formatCurrency(cogsFixedPrice);
        document.getElementById('cogs-fixed-qty').textContent = formatTonnes(cogsFixedTonnes);
        document.getElementById('cogs-fixed-total').textContent = formatCurrency(cogsFixedValue);
        document.getElementById('cogs-unfixed-price').textContent = formatCurrency(cogsUnfixedPrice);
        document.getElementById('cogs-unfixed-qty').textContent = formatTonnes(cogsUnfixedTonnes);
        document.getElementById('cogs-unfixed-total').textContent = formatCurrency(cogsUnfixedValue);
        document.getElementById('cogs-total-qty').textContent = formatTonnes(data.totalSoldTonnes);
        document.getElementById('cogs-total-price').textContent = formatCurrency(avgBuyPrice);
        document.getElementById('cogs-total-sum').textContent = formatCurrency(costOfGoodsSold);
        document.getElementById('open-fixed-price').textContent = formatCurrency(fixedOpenPrice);
        document.getElementById('open-fixed-qty').textContent = formatTonnes(fixedOpenTonnes);
        document.getElementById('open-fixed-total').textContent = formatCurrency(fixedOpenValue);
        document.getElementById('open-unfixed-price').textContent = formatCurrency(unfixedOpenPrice);
        document.getElementById('open-unfixed-qty').textContent = formatTonnes(unfixedOpenTonnes);
        document.getElementById('open-unfixed-total').textContent = formatCurrency(unfixedOpenValue);
        document.getElementById('details-open-qty').textContent = formatTonnes(openPosition);
        document.getElementById('details-open-price').textContent = formatCurrency(avgBuyPrice);
        document.getElementById('details-open-total').textContent = formatCurrency(openPositionCost);
        document.getElementById('sell-fixed-price').textContent = formatCurrency(fixedSellPrice);
        document.getElementById('sell-fixed-qty').textContent = formatTonnes(fixedSoldTonnes);
        document.getElementById('sell-fixed-total').textContent = formatCurrency(fixedSoldValue);
        document.getElementById('sell-unfixed-price').textContent = formatCurrency(unfixedSellPrice);
        document.getElementById('sell-unfixed-qty').textContent = formatTonnes(unfixedSoldTonnes);
        document.getElementById('sell-unfixed-total').textContent = formatCurrency(unfixedSoldValue);
        document.getElementById('details-sell-qty').textContent = formatTonnes(data.totalSoldTonnes);
        document.getElementById('details-sell-price').textContent = formatCurrency(avgSellPrice);
        document.getElementById('details-sell-total').textContent = formatCurrency(data.totalSoldValue);

        const actualProfit = data.totalSoldValue - costOfGoodsSold;
        document.getElementById('summary-sold-qty').textContent = formatTonnes(data.totalSoldTonnes);
        document.getElementById('summary-actual-income').textContent = formatCurrency(data.totalSoldValue, true);
        document.getElementById('summary-actual-cogs').textContent = formatCurrency(costOfGoodsSold, true);
        const summaryActualProfitEl = document.getElementById('summary-actual-profit');
        summaryActualProfitEl.textContent = formatCurrency(actualProfit);
        summaryActualProfitEl.classList.toggle('text-red-600', actualProfit < 0);
        summaryActualProfitEl.classList.toggle('text-green-600', actualProfit >= 0);
        
        const projectedSellPrice = parseFloat(document.getElementById('projected-sell-price').value.replace(',', '.')) || 0;
        const projectedIncome = openPosition * projectedSellPrice;
        const projectedProfit = projectedIncome - openPositionCost;
        
        document.getElementById('summary-open-qty').textContent = formatTonnes(openPosition);
        document.getElementById('projected-income').textContent = formatCurrency(projectedIncome, true);
        document.getElementById('projected-cogs').textContent = formatCurrency(openPositionCost, true);
        const projectedProfitEl = document.getElementById('projected-profit');
        projectedProfitEl.textContent = formatCurrency(projectedProfit);
        projectedProfitEl.classList.toggle('text-red-600', projectedProfit < 0);
        projectedProfitEl.classList.toggle('text-green-600', projectedProfit >= 0);
        
        const totalProjectedProfit = actualProfit + projectedProfit;
        const totalSummaryActualProfitEl = document.getElementById('total-summary-actual-profit');
        totalSummaryActualProfitEl.textContent = formatCurrency(actualProfit);
        totalSummaryActualProfitEl.classList.toggle('text-red-400', actualProfit < 0);
        totalSummaryActualProfitEl.classList.toggle('text-green-400', actualProfit >= 0);

        const totalSummaryProjectedProfitEl = document.getElementById('total-summary-projected-profit');
        totalSummaryProjectedProfitEl.textContent = formatCurrency(projectedProfit, true);
        totalSummaryProjectedProfitEl.classList.toggle('text-red-400', projectedProfit < 0);
        totalSummaryProjectedProfitEl.classList.toggle('text-green-400', projectedProfit >= 0);
        
        const totalProjectedProfitEl = document.getElementById('total-projected-profit');
        totalProjectedProfitEl.textContent = formatCurrency(totalProjectedProfit);
        totalProjectedProfitEl.classList.toggle('text-red-400', totalProjectedProfit < 0);
        totalProjectedProfitEl.classList.toggle('text-green-400', totalProjectedProfit >= 0);

        // Vidurkių blokas
        const actualProfitPerTon = data.totalSoldTonnes > 0 ? actualProfit / data.totalSoldTonnes : 0;
        const projectedProfitPerTon = openPosition > 0 ? projectedProfit / openPosition : 0;
        const totalProfitPerTon = data.totalPurchasedTonnes > 0 ? totalProjectedProfit / data.totalPurchasedTonnes : 0;
        
        document.getElementById('summary-avg-buy-price').textContent = formatCurrencyPerTon(avgBuyPrice);
        document.getElementById('summary-avg-actual-sell-price').textContent = formatCurrencyPerTon(avgSellPrice);
        
        const summaryActualProfitPerTonEl = document.getElementById('summary-actual-profit-per-ton');
        summaryActualProfitPerTonEl.textContent = formatCurrencyPerTon(actualProfitPerTon);
        summaryActualProfitPerTonEl.classList.toggle('text-red-600', actualProfitPerTon < 0);
        summaryActualProfitPerTonEl.classList.toggle('text-green-600', actualProfitPerTon >= 0);

        const summaryProjectedProfitPerTonEl = document.getElementById('summary-projected-profit-per-ton');
        summaryProjectedProfitPerTonEl.textContent = formatCurrencyPerTon(projectedProfitPerTon);
        summaryProjectedProfitPerTonEl.classList.toggle('text-red-600', projectedProfitPerTon < 0);
        summaryProjectedProfitPerTonEl.classList.toggle('text-green-600', projectedProfitPerTon >= 0);
        
        const totalProfitPerTonEl = document.getElementById('summary-total-profit-per-ton');
        totalProfitPerTonEl.textContent = formatCurrencyPerTon(totalProfitPerTon);
        totalProfitPerTonEl.classList.toggle('text-red-600', totalProfitPerTon < 0);
        totalProfitPerTonEl.classList.toggle('text-green-600', totalProfitPerTon >= 0);
    }
    
    // --- PRADINIS INICIALIZAVIMAS ---
    function initialize() {
        const grainSelect = document.getElementById('grain-select');
        for (const [key, value] of Object.entries(allData)) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = value.name;
            grainSelect.appendChild(option);
        }
        grainSelect.value = state.selectedGrain;

        const now = new Date();
        document.getElementById('timestamp').textContent = `Duomenys atnaujinti: ${now.toISOString().slice(0, 10)} ${now.toTimeString().slice(0, 5)}`;
        
        const marketDate = document.getElementById('market-date');
        if(marketDate) {
            marketDate.value = now.toISOString().slice(0, 10);
        }
        
        const periodSelect = document.getElementById('period-select');
        const dateRangePicker = document.getElementById('date-range-picker');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');

        periodSelect.addEventListener('change', (e) => {
            state.selectedPeriod = e.target.value;
            if (e.target.value === 'pasirinkti') {
                dateRangePicker.classList.remove('hidden');
            } else {
                dateRangePicker.classList.add('hidden');
            }
            renderDashboard();
        });

        startDateInput.addEventListener('change', renderDashboard);
        endDateInput.addEventListener('change', renderDashboard);
        document.getElementById('grain-select').addEventListener('change', renderDashboard);
        document.getElementById('projected-sell-price').addEventListener('input', renderDashboard);
        
        renderDashboard();
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>

