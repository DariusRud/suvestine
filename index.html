<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuždarytų Sutarčių Suvestinė</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f3f4f6; 
            color: #1f2f37; 
            font-family: 'Inter', sans-serif;
        }
        .main-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .form-input, .form-select {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            color: #1f2f37;
        }
        .form-input:focus, .form-select:focus {
            --tw-ring-color: #2563eb;
            border-color: #2563eb;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }
        .summary-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .summary-row:last-child {
            border-bottom: none;
        }
        .summary-label {
            color: #4b5563;
        }
        .summary-value {
            font-weight: 600;
            font-family: 'mono', monospace;
            text-align: right;
        }
        .summary-total {
            font-weight: 700;
            font-size: 1.125rem;
            border-top: 2px solid #d1d5db;
            margin-top: 0.75rem;
        }
        .inactive-block {
            opacity: 0.5;
            pointer-events: none;
        }
        /* Tab'ų stiliai */
        .tab-button.active {
            color: #92400e; /* amber-800 */
            border-color: #92400e; /* amber-800 */
        }
        .static-mode-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.05);
            z-index: 999;
        }
        /* Modal styles */
        #share-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="static-mode-overlay"></div>

    <div id="toast-message" class="fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
        Ataskaita sėkmingai išsaugota!
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Antraštė -->
        <header class="mb-4 text-center">
            <div id="timestamp" class="text-sm text-gray-500 font-semibold mb-2"></div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Neuždarytų Pirkimo ir Pardavimo sutarčių SUVESTINĖ <br class="md:hidden"><span class="font-normal text-2xl">(Pelningumo prognozė)</span></h1>
        </header>

        <!-- Tab'ų Navigacija -->
        <div class="sticky top-0 z-20 py-2 bg-gray-100 border-b border-gray-300 flex justify-center items-center shadow-sm relative">
            <ul class="flex flex-wrap -mb-px text-lg font-medium text-center" id="tabs-nav">
                <li role="presentation">
                    <button class="tab-button inline-block p-4 border-b-2 rounded-t-lg" id="summary-tab" type="button">Suvestinė</button>
                </li>
                <li role="presentation">
                    <button class="tab-button inline-block p-4 border-b-2 rounded-t-lg" id="details-tab" type="button">Pamėnesiui</button>
                </li>
                <li role="presentation">
                    <button class="tab-button inline-block p-4 border-b-2 rounded-t-lg" id="history-tab" type="button">Istorija</button>
                </li>
            </ul>
             <div id="save-button-container" class="absolute right-0 pr-4">
                 <button id="save-report-btn" class="bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-400 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Išsaugoti
                </button>
            </div>
        </div>
        
        <!-- Filtrai (bendri abiem tab'ams) -->
        <div id="filters-box" class="mt-6 mb-8 p-6 main-card rounded-xl max-w-3xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="grain-select" class="block text-sm font-medium text-gray-700 mb-2">Kultūra</label>
                    <select id="grain-select" class="form-select w-full rounded-md shadow-sm"></select>
                </div>
                <div>
                    <label for="period-select" class="block text-sm font-medium text-gray-700 mb-2">Laikotarpis</label>
                    <select id="period-select" class="form-select w-full rounded-md shadow-sm">
                        <option value="visas">Visas laikotarpis</option>
                        <option value="pasirinkti">Pasirinkti datas</option>
                    </select>
                </div>
                <div id="date-range-picker" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">Nuo</label>
                        <input type="date" id="start-date" class="form-input w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">Iki</label>
                        <input type="date" id="end-date" class="form-input w-full rounded-md shadow-sm">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab'ų Turinys -->
        <div id="tab-content">
            <!-- SUVESTINĖS TAB'as -->
            <div id="summary-panel">
                <div class="max-w-3xl mx-auto space-y-8">
                    <!-- Rinkos Indeksai -->
                    <div class="p-6 main-card rounded-xl">
                        <h2 class="section-title mb-4">Rinkos Indeksai</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div>
                               <label for="market-date" class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                               <input type="date" id="market-date" class="form-input w-full rounded-md shadow-sm">
                            </div>
                            <div>
                               <label for="matif-rapeseed" class="block text-sm font-medium text-gray-700 mb-2">Matif Rapsai (€/t)</label>
                               <input type="text" inputmode="decimal" id="matif-rapeseed" class="form-input w-full rounded-md shadow-sm">
                           </div>
                           <div>
                               <label for="matif-wheat" class="block text-sm font-medium text-gray-700 mb-2">Matif Kviečiai (€/t)</label>
                               <input type="text" inputmode="decimal" id="matif-wheat" class="form-input w-full rounded-md shadow-sm">
                           </div>
                            <div>
                               <label for="fob-malt" class="block text-sm font-medium text-gray-700 mb-2">FOB Salyklas (€/t)</label>
                               <input type="text" inputmode="decimal" id="fob-malt" class="form-input w-full rounded-md shadow-sm">
                           </div>
                        </div>
                    </div>

                    <!-- Bendra Prognozė (PERKELTA) -->
                    <div class="p-6 main-card rounded-xl bg-amber-900 text-white">
                        <h3 class="font-semibold text-amber-100 mb-4">Bendra Prognozė (Faktas + Prognozė)</h3>
                        <div class="summary-row border-amber-700">
                            <span class="summary-label text-amber-200">Faktinis pelnas / nuostolis</span>
                            <div>
                                <span id="total-summary-actual-profit" class="summary-value text-amber-100 block">€0</span>
                                <span id="total-summary-actual-profit-per-ton" class="block text-xs font-normal text-amber-300 text-right font-mono">(€0,00/t)</span>
                            </div>
                        </div>
                        <div class="summary-row border-amber-700" id="total-surplus-row">
                            <span class="summary-label text-amber-200">Prognozuojamas pelnas / nuostolis (neparduotam kiekui)</span>
                             <div>
                                <span id="total-summary-surplus-profit" class="summary-value text-amber-100 block">€0</span>
                                <span id="total-summary-surplus-profit-per-ton" class="block text-xs font-normal text-amber-300 text-right font-mono">(€0,00/t)</span>
                            </div>
                        </div>
                        <div class="summary-row border-amber-700" id="total-deficit-row">
                            <span class="summary-label text-amber-200">Prognozuojamas pelnas / nuostolis (reikiamo kiekio)</span>
                            <div>
                                <span id="total-summary-deficit-profit" class="summary-value text-amber-100 block">€0</span>
                                <span id="total-summary-deficit-profit-per-ton" class="block text-xs font-normal text-amber-300 text-right font-mono">(€0,00/t)</span>
                            </div>
                        </div>
                        <div class="summary-row summary-total border-amber-600">
                            <span class="summary-label text-lg text-amber-100">Bendras Prognozuojamas Pelnas / Nuostolis</span>
                            <span id="total-projected-profit" class="summary-value text-2xl">€0</span>
                        </div>
                         <div class="summary-row summary-total border-t-2 border-amber-500 pt-4 mt-4">
                            <span class="summary-label text-lg text-amber-100 font-bold">Vidutinis bendras pelnas / nuostolis (€/t)</span>
                            <span id="summary-total-profit-per-ton" class="summary-value text-xl font-bold">€0,00</span>
                        </div>
                    </div>
            
                    <!-- Pirkimai -->
                    <div class="p-6 main-card rounded-xl">
                        <h2 class="section-title mb-6">Pirkimai</h2>
                        <div class="grid grid-cols-1 gap-6">
                            <div class="p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-gray-800 mb-4">NUPIRKTAS KIEKIS, T. <span class="font-normal text-green-600">(PARDUOTA)</span></h3>
                                <div class="space-y-3 text-sm">
                                     <div class="grid grid-cols-4 gap-4 text-xs text-gray-500 font-semibold">
                                        <span class="col-span-1">Tipas</span>
                                        <span class="text-right">Savikaina</span>
                                        <span class="text-right">Kiekis</span>
                                        <span class="text-right">Savikainos Suma</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center">
                                        <span class="text-gray-600">Fiksuota kaina:</span>
                                        <span id="cogs-fixed-price" class="text-right font-mono">€0</span>
                                        <span id="cogs-fixed-qty" class="text-right font-mono">0 t</span>
                                        <span id="cogs-fixed-total" class="font-bold text-right font-mono">€0</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center">
                                        <span class="text-gray-600">Nefiksuota kaina:</span>
                                        <span id="cogs-unfixed-price" class="text-right font-mono">€0</span>
                                        <span id="cogs-unfixed-qty" class="text-right font-mono">0 t</span>
                                        <span id="cogs-unfixed-total" class="font-bold text-right font-mono">€0</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center pt-3 border-t mt-3">
                                        <span class="font-bold text-gray-700">Viso:</span>
                                        <span id="cogs-total-price" class="text-right font-mono font-bold text-base">€0</span>
                                        <span id="cogs-total-qty" class="text-right font-mono font-bold text-base">0 t</span>
                                        <span id="cogs-total-sum" class="text-right font-mono font-bold text-base">€0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-gray-800 mb-4">NUPIRKTAS KIEKIS, T. <span class="font-normal text-red-600">(NEPARDUOTAS)</span></h3>
                                <div class="space-y-3 text-sm">
                                     <div class="grid grid-cols-4 gap-4 text-xs text-gray-500 font-semibold">
                                        <span class="col-span-1">Tipas</span>
                                        <span class="text-right">Savikaina</span>
                                        <span class="text-right">Kiekis</span>
                                        <span class="text-right">Savikainos Suma</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center">
                                        <span class="text-gray-600">Fiksuota kaina:</span>
                                        <span id="open-fixed-price" class="text-right font-mono">€0</span>
                                        <span id="open-fixed-qty" class="text-right font-mono">0 t</span>
                                        <span id="open-fixed-total" class="font-bold text-right font-mono">€0</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center">
                                        <span class="text-gray-600">Nefiksuota kaina:</span>
                                        <span id="open-unfixed-price" class="text-right font-mono">€0</span>
                                        <span id="open-unfixed-qty" class="text-right font-mono">0 t</span>
                                        <span id="open-unfixed-total" class="font-bold text-right font-mono">€0</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center pt-3 border-t mt-3">
                                        <span class="font-bold text-gray-700">Viso:</span>
                                        <span id="details-open-price" class="text-right font-mono font-bold text-base">€0</span>
                                        <span id="details-open-qty" class="text-right font-mono font-bold text-base">0 t</span>
                                        <span id="details-open-total" class="text-right font-mono font-bold text-base">€0</span>
                                    </div>
                                </div>
                            </div>
                             <!-- Likutis Sandėlyje -->
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h3 class="font-bold text-gray-800 mb-4">LIKUTIS SANDĖLYJE <span class="font-normal text-blue-600">(RANKINIS ĮVEDIMAS)</span></h3>
                                <div class="grid grid-cols-4 gap-4 items-end text-sm">
                                    <span class="text-gray-600 col-span-1">Papildomas likutis:</span>
                                    <div>
                                        <label for="inventory-price" class="block text-xs text-gray-500 mb-1">Savikaina, €/t</label>
                                        <input type="text" inputmode="decimal" id="inventory-price" class="form-input w-full rounded-md shadow-sm text-right font-mono" value="0">
                                    </div>
                                    <div>
                                        <label for="inventory-qty" class="block text-xs text-gray-500 mb-1">Kiekis, t</label>
                                        <input type="text" inputmode="decimal" id="inventory-qty" class="form-input w-full rounded-md shadow-sm text-right font-mono" value="0">
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-xs text-gray-500 mb-1">Savikainos Suma</span>
                                        <span id="inventory-total" class="font-bold font-mono text-base">€0,00</span>
                                    </div>
                                </div>
                            </div>
                             <!-- Viso Neparduota -->
                            <div class="p-4 bg-gray-200 rounded-lg border border-gray-300">
                                <h3 class="font-bold text-gray-800 mb-4">VISO NEPARDUOTA</h3>
                                <div class="grid grid-cols-4 gap-4 items-center text-sm">
                                    <span class="font-bold col-span-1">Bendrai:</span>
                                    <span id="total-unsold-price" class="text-right font-mono font-bold text-base">€0</span>
                                    <span id="total-unsold-qty" class="text-right font-mono font-bold text-base">0 t</span>
                                    <span id="total-unsold-total" class="font-bold text-right font-mono text-base">€0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pardavimai -->
                    <div class="p-6 main-card rounded-xl">
                        <h2 class="section-title mb-6">Pardavimai</h2>
                        <div class="grid grid-cols-1 gap-6">
                            <div class="p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-bold text-gray-800 mb-4">PARDUOTAS KIEKIS, T. <span class="font-normal text-red-600">(PASIRAŠYTOS SUTARTYS)</span></h3>
                                 <div class="space-y-3 text-sm">
                                     <div class="grid grid-cols-4 gap-4 text-xs text-gray-500 font-semibold">
                                        <span class="col-span-1">Tipas</span>
                                        <span class="text-right">Kaina</span>
                                        <span class="text-right">Kiekis</span>
                                        <span class="text-right">Suma</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center">
                                        <span class="text-gray-600">Fiksuota kaina:</span>
                                        <span id="sell-fixed-price" class="text-right font-mono">€0</span>
                                        <span id="sell-fixed-qty" class="text-right font-mono">0 t</span>
                                        <span id="sell-fixed-total" class="font-bold text-right font-mono">€0</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center">
                                        <span class="text-gray-600">Nefiksuota kaina:</span>
                                        <span id="sell-unfixed-price" class="text-right font-mono">€0</span>
                                        <span id="sell-unfixed-qty" class="text-right font-mono">0 t</span>
                                        <span id="sell-unfixed-total" class="font-bold text-right font-mono">€0</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-4 items-center pt-3 border-t mt-3">
                                        <span class="font-bold text-gray-700">Viso:</span>
                                        <span id="details-sell-price" class="text-right font-mono font-bold text-base">€0</span>
                                        <span id="details-sell-qty" class="text-right font-mono font-bold text-base">0 t</span>
                                        <span id="details-sell-total" class="text-right font-mono font-bold text-base">€0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-semibold text-gray-700 mb-4">Faktinė Būsena (pagal jau įvykdytus sandorius)</h3>
                                <div class="summary-row">
                                    <span class="summary-label">Kiekis (parduota)</span>
                                    <span id="summary-sold-qty" class="summary-value">0 t</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Pajamos (faktinės)</span>
                                    <span id="summary-actual-income" class="summary-value text-green-600">+ €0</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Savikaina (parduota)</span>
                                    <span id="summary-actual-cogs" class="summary-value text-red-600">- €0</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Pelnas / Nuostolis (faktinis)</span>
                                    <span id="summary-actual-profit" class="summary-value text-lg">€0</span>
                                </div>
                                <div class="summary-row pt-4 mt-4 border-t-2 border-gray-200">
                                    <span class="summary-label">Vidutinė pirkimo kaina (€/t)</span>
                                    <span id="summary-avg-buy-price" class="summary-value text-lg">€0,00</span>
                                </div>
                                 <div class="summary-row">
                                    <span class="summary-label">Vidutinė faktinių pardavimų kaina (€/t)</span>
                                    <span id="summary-avg-actual-sell-price" class="summary-value text-lg">€0,00</span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span class="summary-label font-semibold">Vidutinis faktinis pelnas / nuostolis (€/t)</span>
                                    <span id="summary-actual-profit-per-ton" class="summary-value text-lg font-semibold">€0,00</span>
                                </div>
                            </div>
                            <div id="surplus-projection-block" class="p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-semibold text-gray-700 mb-4">Prognozė (neparduotam kiekiui)</h3>
                                <div class="summary-row">
                                    <span class="summary-label">Kiekis (neparduota)</span>
                                    <span id="surplus-open-qty" class="summary-value">0 t</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-center pt-4">
                                     <div>
                                        <label for="projected-sell-price" class="block text-sm font-medium text-gray-700 mb-1">Jeigu parduotume po (€/t): <span class="text-red-600 font-normal">(įrašyti kainos sumą)</span></label>
                                        <input type="text" inputmode="decimal" id="projected-sell-price" class="form-input w-full rounded-md shadow-sm">
                                    </div>
                                    <div></div>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Prognozuojamos pajamos</span>
                                    <span id="projected-income" class="summary-value text-green-600">+ €0</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Savikaina (neparduota)</span>
                                    <span id="projected-cogs" class="summary-value text-red-600">- €0</span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span class="summary-label">Pelnas / Nuostolis (prognozuojamas)</span>
                                    <span id="projected-profit" class="summary-value text-lg">€0</span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span class="summary-label font-semibold">Vidutinis prognozuojamas pelnas / nuostolis (€/t)</span>
                                    <span id="surplus-projected-profit-per-ton" class="summary-value text-lg font-semibold">€0,00</span>
                                </div>
                            </div>
                            <div id="deficit-projection-block" class="p-4 bg-gray-50 rounded-lg border">
                                <h3 class="font-semibold text-gray-700 mb-4">Prognozė (trūkstamam kiekiui)</h3>
                                <div class="summary-row">
                                    <span class="summary-label">Kiekis (trūkstamas)</span>
                                    <span id="deficit-open-qty" class="summary-value">0 t</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-center pt-4">
                                     <div>
                                        <label for="projected-buy-price" class="block text-sm font-medium text-gray-700 mb-1">Jeigu nupirktume po (€/t): <span class="text-red-600 font-normal">(įrašyti kainos sumą)</span></label>
                                        <input type="text" inputmode="decimal" id="projected-buy-price" class="form-input w-full rounded-md shadow-sm">
                                    </div>
                                    <div></div>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Pajamos (už trūkstamą kiekį)</span>
                                    <span id="deficit-income" class="summary-value text-green-600">+ €0</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Prognozuojamos išlaidos</span>
                                    <span id="deficit-cogs" class="summary-value text-red-600">- €0</span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span class="summary-label">Pelnas / Nuostolis (prognozuojamas)</span>
                                    <span id="deficit-profit" class="summary-value text-lg">€0</span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span class="summary-label font-semibold">Vidutinis prognozuojamas pelnas / nuostolis (€/t)</span>
                                    <span id="deficit-projected-profit-per-ton" class="summary-value text-lg font-semibold">€0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- DETALIZAVIMO TAB'as -->
            <div id="reports-panel" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Detali Ataskaita pagal Mėnesius</h2>
                    <h3 id="details-report-grain-title" class="text-xl font-semibold text-gray-700 mb-6"></h3>
                    <div id="reports-content">
                        <!-- Detalių ataskaitų turinys bus generuojamas čia -->
                    </div>
                </div>
            </div>

            <!-- ISTORIJOS TAB'as -->
            <div id="history-panel" class="hidden">
                <div class="max-w-3xl mx-auto p-6 main-card rounded-xl mt-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="section-title">Išsaugotų Ataskaitų Istorija</h2>
                        <button id="share-selected-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" disabled>
                            Dalintis pažymėtais
                        </button>
                    </div>
                    <div id="history-list" class="space-y-3">
                        <!-- Istorijos įrašai bus generuojami čia -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="absolute inset-0 bg-gray-800 opacity-75"></div>
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg z-10">
            <h3 class="text-xl font-bold mb-4">Dalintis Ataskaitų Nuorodomis</h3>
            <div class="mb-4">
                <label for="share-email" class="block text-sm font-medium text-gray-700 mb-1">Gavėjo el. paštas</label>
                <input type="email" id="share-email" class="form-input w-full rounded-md shadow-sm" placeholder="pvz@email.com">
            </div>
            <div class="mb-6">
                <label for="share-links" class="block text-sm font-medium text-gray-700 mb-1">Ataskaitų nuorodos</label>
                <textarea id="share-links" rows="5" class="form-input w-full rounded-md shadow-sm bg-gray-100" readonly></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="close-modal-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Uždaryti</button>
                <button id="send-email-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Siųsti</button>
            </div>
        </div>
    </div>


<script>
    // --- DUOMENŲ BAZĖS SIMULIACIJA ---
    const allData = {
        'amie': { name: 'Adjunct miežiai', transactions: [] },
        'aviz': { name: 'Avižos', transactions: [] },
        'eko': { name: 'Ekologiniai grūdai', transactions: [] },
        'ekol': { name: 'Ekologiniai grūdai', transactions: [] },
        'emie': { name: 'Ekologiniai miežiai', transactions: [] },
        'epup': { name: 'Ekologinės pupos', transactions: [] },
        'grik': { name: 'Grikiai', transactions: [] },
        'kuku': { name: 'Kukurūzai', transactions: [] },
        'kvie': { 
            name: 'Kviečiai',
             transactions: [
                { date: '2025-09-01', type: 'purchase', tonnes: 85000, value: 16150000 },
                { date: '2025-11-01', type: 'sale', tonnes: 72000, value: 15120000 }
            ]
        },
        'kvru': { name: 'Kvietrugiai', transactions: [] },
        'lubi': { name: 'Lubinai', transactions: [] },
        'malto': { name: 'Maltosa salyklas', transactions: [] },
        'miez': { 
            name: 'Miežiai', 
            transactions: [
                { date: '2025-08-20', type: 'purchase', tonnes: 50000, value: 9500000 },
                { date: '2025-10-15', type: 'sale', tonnes: 43000, value: 8600000 }
            ]
        },
        'pak01': { name: 'Grūdų pakavimo prekės', transactions: [] },
        'pasa': { name: 'Pašarai', transactions: [] },
        'pmie': { name: 'Pašariniai miežiai', transactions: [] },
        'pupo': { name: 'Pupos', transactions: [] },
        'raps': { 
            name: 'Rapsai',
            transactions: [
                { date: '2025-07-25', type: 'purchase', tonnes: 25000, value: 11250000 },
                { date: '2025-09-25', type: 'sale', tonnes: 26000, value: 12220000 }
            ]
        },
        'rugi': { name: 'Rugiai', transactions: [] },
        'saul': { name: 'Saulėgrąžos', transactions: [] },
        'sekl': { name: 'Sėklos', transactions: [] },
        'smie': {
            name: 'Salykliniai miežiai',
            transactions: [
                { date: '2025-09-15', type: 'purchase', tonnes: 26000, value: 5174000 },
                { date: '2026-02-20', type: 'purchase', tonnes: 24900, value: 4955100 },
                { date: '2025-10-05', type: 'sale', tonnes: 19500, value: 4270500 },
                { date: '2026-04-10', type: 'sale', tonnes: 19400, value: 4266984 }
            ]
        },
        'sojo': { name: 'Sojos', transactions: [] },
        'tras': { name: 'Trašos', transactions: [] },
        'viki': { name: 'Vikiai', transactions: [] },
        'vmalt': { name: 'Viking salyklas', transactions: [] },
        'zirn': { name: 'Žirniai', transactions: [] }
    };

    const state = { selectedGrain: 'smie', selectedPeriod: 'visas' };
    
     const formatCurrency = (val, sign, plain = false) => {
        if (plain) {
            const num = new Intl.NumberFormat('lt-LT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
            if(sign) {
                return (val >= 0 ? '+' : '') + num;
            }
            return num;
        }

        if (sign) {
            const prefix = val >= 0 ? '+' : '-';
            const formattedVal = new Intl.NumberFormat('lt-LT', { style: 'currency', currency: 'EUR' }).format(Math.abs(val));
            return `${prefix} ${formattedVal}`;
        }
        return new Intl.NumberFormat('lt-LT', { style: 'currency', currency: 'EUR' }).format(val);
    };
    const formatCurrencyPerTon = (val, plain = false) => {
         if (plain) {
             return new Intl.NumberFormat('lt-LT', { 
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(val);
         }
        return new Intl.NumberFormat('lt-LT', { 
            style: 'currency', 
            currency: 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(val);
    };
    const formatTonnes = (val, plain = false) => {
        const formattedVal = new Intl.NumberFormat('lt-LT', {maximumFractionDigits: 0}).format(val);
        return plain ? formattedVal : `${formattedVal} t`;
    };
    const formatTonnesWithSign = (val, plain = false) => {
        const sign = val >= 0 ? '+' : '';
        const formattedVal = new Intl.NumberFormat('lt-LT', {maximumFractionDigits: 0}).format(val);
        const result = `${sign}${formattedVal}`;
        return plain ? result : `${result} t`;
    };

    function getFilteredData() {
        const grainKey = state.selectedGrain;
        
        let transactionsToProcess = [];
        if (grainKey === 'visi') {
            transactionsToProcess = Object.values(allData).flatMap(grain => grain.transactions);
        } else {
            const grainData = allData[grainKey];
            if (grainData) {
                transactionsToProcess = grainData.transactions;
            }
        }

        const periodSelection = document.getElementById('period-select').value;
        if (periodSelection === 'pasirinkti') {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (startDate && endDate) {
                transactionsToProcess = transactionsToProcess.filter(t => t.date >= startDate && t.date <= endDate);
            }
        }

        const result = { totalPurchasedTonnes: 0, totalPurchaseValue: 0, totalSoldTonnes: 0, totalSoldValue: 0 };
        transactionsToProcess.forEach(t => {
            if (t.type === 'purchase') {
                result.totalPurchasedTonnes += t.tonnes;
                result.totalPurchaseValue += t.value;
            } else if (t.type === 'sale') {
                result.totalSoldTonnes += t.tonnes;
                result.totalSoldValue += t.value;
            }
        });
        return result;
    }

    function getDetailedMonthlyData() {
        const grainKey = document.getElementById('grain-select').value;
        const periodSelection = document.getElementById('period-select').value;
        
        let transactions = [];
        if (grainKey === 'visi') {
            transactions = Object.values(allData).flatMap(g => g.transactions);
        } else {
            transactions = allData[grainKey] ? allData[grainKey].transactions : [];
        }

        if (periodSelection === 'pasirinkti') {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (startDate && endDate) {
                transactions = transactions.filter(t => t.date >= startDate && t.date <= endDate);
            }
        }

        const monthlyData = {};
        
        transactions.forEach(t => {
            const month = t.date.substring(0, 7); // YYYY-MM
            if (!monthlyData[month]) {
                monthlyData[month] = {
                    purchase: { tonnes: 0, value: 0 },
                    sale: { tonnes: 0, value: 0 },
                };
            }
            if (t.type === 'purchase') {
                monthlyData[month].purchase.tonnes += t.tonnes;
                monthlyData[month].purchase.value += t.value;
            } else if (t.type === 'sale') {
                monthlyData[month].sale.tonnes += t.tonnes;
                monthlyData[month].sale.value += t.value;
            }
        });
        
        const reportData = Object.keys(monthlyData).sort().map(month => {
            const monthInfo = monthlyData[month];
            const profit = monthInfo.sale.value - monthInfo.purchase.value;
            const monthlyChange = monthInfo.purchase.tonnes - monthInfo.sale.tonnes;

            return {
                month: month.replace('-', '.'),
                purchase: { total_t: monthInfo.purchase.tonnes, total_v: monthInfo.purchase.value },
                sale: { total_t: monthInfo.sale.tonnes, total_v: monthInfo.sale.value },
                profit: profit,
                monthlyChange: monthlyChange,
            };
        });
        
        return reportData;
    }
    
    function checkSaveButtonState() {
        // Pagal vartotojo pageidavimą, išsaugojimo mygtukas yra visada aktyvus.
        document.getElementById('save-report-btn').disabled = false;
    }


    function renderDetailedReport(totalAvgProfitPerTon, actualProfit) {
        const reportData = getDetailedMonthlyData();
        const container = document.getElementById('reports-content');

        const grainSelect = document.getElementById('grain-select');
        const selectedGrainText = grainSelect.options[grainSelect.selectedIndex].text;
        document.getElementById('details-report-grain-title').innerHTML = `Kultūra: <span class="text-amber-800 font-bold">${selectedGrainText}</span>`;
        
        const inventoryQty = parseFloat(document.getElementById('inventory-qty').value.replace(',', '.')) || 0;
        const inventoryPrice = parseFloat(document.getElementById('inventory-price').value.replace(',', '.')) || 0;
        const inventoryValue = inventoryQty * inventoryPrice;

        if (reportData.length === 0 && inventoryQty === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 py-16">Nėra duomenų ataskaitai pagal pasirinktus filtrus.</p>`;
            return;
        }

        let grandTotal = { purchase_t: 0, purchase_v: 0, sale_t: 0, sale_v: 0, profit: 0 };
        let runningBalance = inventoryQty;

        const inventoryRowHtml = `
                <tr class="border-b border-gray-200 bg-blue-50">
                    <td class="py-3 px-4 text-left whitespace-nowrap font-bold text-blue-800">Likutis sandėlyje (pradinis)</td>
                    <td class="py-3 px-4 text-right font-mono bg-amber-50">${formatTonnes(inventoryQty, true)}</td>
                    <td class="py-3 px-4 text-right font-mono bg-amber-50">${formatCurrencyPerTon(inventoryPrice, true)}</td>
                    <td class="py-3 px-4 text-right font-mono bg-amber-50">${formatCurrency(inventoryValue, false, true)}</td>
                    <td class="py-3 px-4 bg-green-50"></td>
                    <td class="py-3 px-4 bg-green-50"></td>
                    <td class="py-3 px-4 bg-green-50"></td>
                    <td class="py-3 px-4 bg-white"></td>
                    <td class="py-3 px-4 text-right font-mono font-semibold bg-white">${formatTonnes(inventoryQty, true)}</td>
                    <td class="py-3 px-4 bg-white"></td>
                </tr>`;


        const tableRows = reportData.map((month) => {
            grandTotal.purchase_t += month.purchase.total_t;
            grandTotal.purchase_v += month.purchase.total_v;
            grandTotal.sale_t += month.sale.total_t;
            grandTotal.sale_v += month.sale.total_v;
            grandTotal.profit += month.profit;
            
            runningBalance += month.monthlyChange;
            
            const p_avg_price = month.purchase.total_t > 0 ? month.purchase.total_v / month.purchase.total_t : 0;
            const s_avg_price = month.sale.total_t > 0 ? month.sale.total_v / month.sale.total_t : 0;
            const profitClass = month.profit >= 0 ? 'text-green-600' : 'text-red-600';
            const monthlyChangeClass = month.monthlyChange >= 0 ? 'text-green-600' : 'text-red-600';
            const balanceClass = runningBalance < 0 ? 'text-red-600' : 'text-gray-800';

            return `
                <tr class="border-b border-gray-200">
                    <td class="py-3 px-4 text-left whitespace-nowrap font-medium bg-white">${month.month}</td>
                    <td class="py-3 px-4 text-right font-mono bg-amber-50">${formatTonnes(month.purchase.total_t, true)}</td>
                    <td class="py-3 px-4 text-right font-mono bg-amber-50">${formatCurrencyPerTon(p_avg_price, true)}</td>
                    <td class="py-3 px-4 text-right font-mono bg-amber-50">${formatCurrency(month.purchase.total_v, false, true)}</td>
                    <td class="py-3 px-4 text-right font-mono bg-green-50">${formatTonnes(month.sale.total_t, true)}</td>
                    <td class="py-3 px-4 text-right font-mono bg-green-50">${formatCurrencyPerTon(s_avg_price, true)}</td>
                    <td class="py-3 px-4 text-right font-mono bg-green-50">${formatCurrency(month.sale.total_v, false, true)}</td>
                    <td class="py-3 px-4 text-right font-mono font-semibold ${monthlyChangeClass} bg-white">${formatTonnesWithSign(month.monthlyChange, true)}</td>
                    <td class="py-3 px-4 text-right font-mono font-semibold ${balanceClass} bg-white">${formatTonnes(runningBalance, true)}</td>
                    <td class="py-3 px-4 text-right font-mono font-semibold ${profitClass} bg-white">${formatCurrency(month.profit, true, true)}</td>
                </tr>`;
        }).join('');
        
        const grandTotalAvgPurchasePrice = grandTotal.purchase_t > 0 ? grandTotal.purchase_v / grandTotal.purchase_t : 0;
        const grandTotalAvgSalePrice = grandTotal.sale_t > 0 ? grandTotal.sale_v / grandTotal.sale_t : 0;
        const actualProfitClass = actualProfit >= 0 ? 'text-green-700' : 'text-red-700';
        const finalBalance = inventoryQty + grandTotal.purchase_t - grandTotal.sale_t;
        const finalBalanceClass = finalBalance < 0 ? 'text-red-700' : 'text-gray-800';

        let forecastRowHtml = '';
        let forecastProfit = 0;
        const projectedSellPrice = parseFloat(document.getElementById('projected-sell-price').value.replace(',', '.')) || 0;
        const projectedBuyPrice = parseFloat(document.getElementById('projected-buy-price').value.replace(',', '.')) || 0;

        const contractData = getFilteredData();
        const contractOpenQty = contractData.totalPurchasedTonnes - contractData.totalSoldTonnes;
        const totalOpenPosition = contractOpenQty + inventoryQty;
        
        if (totalOpenPosition >= 0) { // Surplus forecast
            const forecastQty = totalOpenPosition;
            const forecastPrice = projectedSellPrice;
            const forecastSum = forecastQty * forecastPrice;

            const inventoryTotalValueForProfit = inventoryQty * inventoryPrice;
            const contractAvgBuyPrice = contractData.totalPurchasedTonnes > 0 ? contractData.totalPurchaseValue / contractData.totalPurchasedTonnes : 0;
            const contractOpenValueForProfit = contractOpenQty * contractAvgBuyPrice;
            const totalOpenPositionValue = contractOpenValueForProfit + inventoryTotalValueForProfit;
            const avgCostPrice = forecastQty > 0 ? totalOpenPositionValue / forecastQty : 0;

            if (forecastPrice > 0) {
                forecastProfit = forecastSum - totalOpenPositionValue;
            }
            
            const profitClass = forecastProfit >= 0 ? 'text-green-700' : 'text-red-700';

            forecastRowHtml = `
                <tr class="border-t border-gray-300">
                    <td class="py-4 px-4 text-left text-amber-800 font-bold bg-gray-100">Prognozė</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-amber-100">${formatTonnes(forecastQty, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-amber-100">${formatCurrencyPerTon(avgCostPrice, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-amber-100">${formatCurrency(totalOpenPositionValue, false, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-green-100">${formatTonnes(forecastQty, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-green-100">${formatCurrencyPerTon(forecastPrice, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-green-100">${formatCurrency(forecastSum, false, true)}</td>
                    <td class="py-4 px-4 bg-gray-200"></td>
                    <td class="py-4 px-4 bg-gray-200"></td>
                    <td class="py-4 px-4 text-right font-mono text-base ${profitClass} bg-gray-200">${formatCurrency(forecastProfit, true, true)}</td>
                </tr>`;
        } else { // Deficit forecast
            const forecastQty = Math.abs(totalOpenPosition);
            const forecastPrice = projectedBuyPrice;
            const forecastSum = forecastQty * forecastPrice;

            const avgSellPrice = contractData.totalSoldTonnes > 0 ? contractData.totalSoldValue / contractData.totalSoldTonnes : 0;
            const revenueForDeficit = forecastQty * avgSellPrice;

            if (forecastPrice > 0) {
                forecastProfit = revenueForDeficit - forecastSum;
            }
            
            const profitClass = forecastProfit >= 0 ? 'text-green-700' : 'text-red-700';

            forecastRowHtml = `
                 <tr class="border-t border-gray-300">
                    <td class="py-4 px-4 text-left text-amber-800 font-bold bg-gray-100">Prognozė</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-amber-100">${formatTonnes(forecastQty, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-amber-100">${formatCurrencyPerTon(forecastPrice, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-amber-100">${formatCurrency(forecastSum, false, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-green-100">${formatTonnes(forecastQty, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-green-100">${formatCurrencyPerTon(avgSellPrice, true)}</td>
                    <td class="py-4 px-4 text-right font-mono text-amber-800 font-bold bg-green-100">${formatCurrency(revenueForDeficit, false, true)}</td>
                    <td class="py-4 px-4 bg-gray-200"></td>
                    <td class="py-4 px-4 bg-gray-200"></td>
                    <td class="py-4 px-4 text-right font-mono text-base ${profitClass} bg-gray-200">${formatCurrency(forecastProfit, true, true)}</td>
                </tr>`;
        }

        const finalProjectedProfit = actualProfit + forecastProfit;
        const finalProjectedProfitClass = finalProjectedProfit >= 0 ? 'text-green-700' : 'text-red-700';

        const finalTotalRowHtml = `
            <tr class="bg-gray-200">
                <td colspan="9" class="py-3 px-4 text-right font-bold text-base">Bendra Suma (su prognoze)</td>
                <td class="py-3 px-4 text-right font-mono font-bold text-base ${finalProjectedProfitClass}">${formatCurrency(finalProjectedProfit, true, true)}</td>
            </tr>
        `;

        const totalAvgProfitClass = totalAvgProfitPerTon >= 0 ? 'text-green-700' : 'text-red-700';
        const finalAvgProfitRow = `
            <tr class="border-t-2 border-gray-400 bg-gray-200">
                <td colspan="9" class="py-3 px-4 text-right font-bold">Bendras vidutinis pelnas / nuostolis (€/t)</td>
                <td class="py-3 px-4 text-right font-mono font-bold ${totalAvgProfitClass}">${formatCurrencyPerTon(totalAvgProfitPerTon, true)}</td>
            </tr>
        `;

        const tableHtml = `
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-md">
            <table class="min-w-full bg-white text-sm">
                <thead class="text-gray-600 uppercase text-xs leading-normal">
                    <tr>
                        <th rowspan="2" class="py-3 px-4 text-left border-b border-r bg-gray-100 align-bottom">Mėnuo</th>
                        <th colspan="3" class="py-3 px-4 text-center border-b border-r bg-amber-100">Pirkimai</th>
                        <th colspan="3" class="py-3 px-4 text-center border-b border-r bg-green-100">Pardavimai</th>
                        <th rowspan="2" class="py-3 px-4 text-right border-b border-r bg-gray-100 align-bottom">Mėnesio +/-, t</th>
                        <th rowspan="2" class="py-3 px-4 text-right border-b border-r bg-gray-100 align-bottom">Likutis, t</th>
                        <th rowspan="2" class="py-3 px-4 text-right border-b bg-gray-100 align-bottom">Pelnas, €</th>
                    </tr>
                    <tr>
                        <th class="py-3 px-4 text-right border-b border-r bg-amber-50">Kiekis, t</th>
                        <th class="py-3 px-4 text-right border-b border-r bg-amber-50">Vid. Kaina, €/t</th>
                        <th class="py-3 px-4 text-right border-b border-r bg-amber-50">Suma, €</th>
                        <th class="py-3 px-4 text-right border-b border-r bg-green-50">Kiekis, t</th>
                        <th class="py-3 px-4 text-right border-b border-r bg-green-50">Vid. Kaina, €/t</th>
                        <th class="py-3 px-4 text-right border-b border-r bg-green-50">Suma, €</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700 font-light">
                    ${(inventoryQty > 0 || reportData.length > 0) ? inventoryRowHtml : ''}
                    ${tableRows}
                </tbody>
                <tfoot class="text-gray-800 font-bold">
                    <tr class="border-t-2 border-gray-300">
                        <td class="py-4 px-4 text-left bg-gray-200">Bendra Suma</td>
                        <td class="py-4 px-4 text-right font-mono bg-amber-100">${formatTonnes(grandTotal.purchase_t, true)}</td>
                        <td class="py-4 px-4 text-right font-mono bg-amber-100">${formatCurrencyPerTon(grandTotalAvgPurchasePrice, true)}</td>
                        <td class="py-4 px-4 text-right font-mono bg-amber-100">${formatCurrency(grandTotal.purchase_v, false, true)}</td>
                        <td class="py-4 px-4 text-right font-mono bg-green-100">${formatTonnes(grandTotal.sale_t, true)}</td>
                        <td class="py-4 px-4 text-right font-mono bg-green-100">${formatCurrencyPerTon(grandTotalAvgSalePrice, true)}</td>
                        <td class="py-4 px-4 text-right font-mono bg-green-100">${formatCurrency(grandTotal.sale_v, false, true)}</td>
                        <td class="py-4 px-4 text-right bg-gray-200"></td>
                        <td class="py-4 px-4 text-right font-mono text-base ${finalBalanceClass} bg-gray-200">${formatTonnes(finalBalance, true)}</td>
                        <td class="py-4 px-4 text-right font-mono text-base ${actualProfitClass} bg-gray-200">${formatCurrency(actualProfit, true, true)}</td>
                    </tr>
                    ${forecastRowHtml}
                    ${finalTotalRowHtml}
                    ${finalAvgProfitRow}
                </tfoot>
            </table>
        </div>
        `;

        container.innerHTML = tableHtml;
    }


    function renderDashboard() {
        state.selectedGrain = document.getElementById('grain-select').value;
        
        // 1. Get manual inventory input
        const inventoryQty = parseFloat(document.getElementById('inventory-qty').value.replace(',', '.')) || 0;
        const inventoryPrice = parseFloat(document.getElementById('inventory-price').value.replace(',', '.')) || 0;
        const inventoryTotalValue = inventoryQty * inventoryPrice;
        document.getElementById('inventory-total').textContent = formatCurrency(inventoryTotalValue);

        // 2. Get contract data from "database"
        const contractData = getFilteredData();
        const contractAvgBuyPrice = contractData.totalPurchasedTonnes > 0 ? contractData.totalPurchaseValue / contractData.totalPurchasedTonnes : 0;
        const totalSoldTonnes = contractData.totalSoldTonnes;
        const totalSoldValue = contractData.totalSoldValue;
        const avgSellPrice = totalSoldTonnes > 0 ? totalSoldValue / totalSoldTonnes : 0;
        
        // 3. Calculate Contract-only open position and its value
        const contractOpenQty = contractData.totalPurchasedTonnes - totalSoldTonnes;
        const contractOpenValue = contractOpenQty * contractAvgBuyPrice;

        // 4. Calculate TOTAL unsold goods and their WEIGHTED AVERAGE cost
        const totalUnsoldQty = contractOpenQty + inventoryQty;
        const totalUnsoldValue = contractOpenValue + inventoryTotalValue;
        const totalUnsoldAvgPrice = totalUnsoldQty > 0 ? totalUnsoldValue / totalUnsoldQty : 0;
        
        // 5. Calculate Cost of Goods Sold (COGS) using CONTRACT-ONLY average price
        const costOfGoodsSold = totalSoldTonnes * contractAvgBuyPrice;
        
        // 6. Calculate TOTAL open position (for projections) - this is the same as totalUnsold
        const totalOpenPosition = totalUnsoldQty;
        const totalOpenPositionValue = totalUnsoldValue;


        // --- UI POPULATION ---

        // Cosmetic splits for display - these don't affect main calculations
        const fixedRatio = 0.4;
        const priceAdjustment = 2;

        // Populate "Nupirktas kiekis (parduota)" - COGS
        document.getElementById('cogs-total-qty').textContent = formatTonnes(totalSoldTonnes);
        document.getElementById('cogs-total-price').textContent = formatCurrencyPerTon(contractAvgBuyPrice);
        document.getElementById('cogs-total-sum').textContent = formatCurrency(costOfGoodsSold);
        const cogsFixedTonnes = totalSoldTonnes * fixedRatio;
        const cogsUnfixedTonnes = totalSoldTonnes * (1-fixedRatio);
        const cogsFixedPrice = contractAvgBuyPrice - priceAdjustment;
        const cogsFixedValue = cogsFixedTonnes * cogsFixedPrice;
        const cogsUnfixedValue = costOfGoodsSold - cogsFixedValue;
        const cogsUnfixedPrice = cogsUnfixedTonnes > 0 ? cogsUnfixedValue / cogsUnfixedTonnes : 0;
        document.getElementById('cogs-fixed-price').textContent = formatCurrencyPerTon(cogsFixedPrice);
        document.getElementById('cogs-unfixed-price').textContent = formatCurrencyPerTon(cogsUnfixedPrice);
        document.getElementById('cogs-fixed-qty').textContent = formatTonnes(cogsFixedTonnes);
        document.getElementById('cogs-unfixed-qty').textContent = formatTonnes(cogsUnfixedTonnes);
        document.getElementById('cogs-fixed-total').textContent = formatCurrency(cogsFixedValue);
        document.getElementById('cogs-unfixed-total').textContent = formatCurrency(cogsUnfixedValue);
        
        // Populate "Nupirktas kiekis (neparduotas)" - Contract-only open position
        document.getElementById('details-open-qty').textContent = formatTonnes(contractOpenQty);
        document.getElementById('details-open-price').textContent = formatCurrencyPerTon(contractAvgBuyPrice);
        document.getElementById('details-open-total').textContent = formatCurrency(contractOpenValue);
        const openFixedTonnes = contractOpenQty * fixedRatio;
        const openUnfixedTonnes = contractOpenQty * (1-fixedRatio);
        const openFixedPrice = contractAvgBuyPrice - priceAdjustment;
        const openFixedValue = openFixedTonnes * openFixedPrice;
        const openUnfixedValue = contractOpenValue - openFixedValue;
        const openUnfixedPrice = openUnfixedTonnes > 0 ? openUnfixedValue/openUnfixedTonnes:0;
        document.getElementById('open-fixed-price').textContent = formatCurrencyPerTon(openFixedPrice);
        document.getElementById('open-unfixed-price').textContent = formatCurrencyPerTon(openUnfixedPrice);
        document.getElementById('open-fixed-qty').textContent = formatTonnes(openFixedTonnes);
        document.getElementById('open-unfixed-qty').textContent = formatTonnes(openUnfixedTonnes);
        document.getElementById('open-fixed-total').textContent = formatCurrency(openFixedValue);
        document.getElementById('open-unfixed-total').textContent = formatCurrency(openUnfixedValue);

        // Populate NEW "Viso neparduota" block
        document.getElementById('total-unsold-qty').textContent = formatTonnes(totalUnsoldQty);
        document.getElementById('total-unsold-price').textContent = formatCurrencyPerTon(totalUnsoldAvgPrice);
        document.getElementById('total-unsold-total').textContent = formatCurrency(totalUnsoldValue);

        // Populate "Pardavimai" blocks
        document.getElementById('details-sell-qty').textContent = formatTonnes(totalSoldTonnes);
        document.getElementById('details-sell-price').textContent = formatCurrencyPerTon(avgSellPrice);
        document.getElementById('details-sell-total').textContent = formatCurrency(totalSoldValue);
        const sellFixedTonnes = totalSoldTonnes * fixedRatio;
        const sellUnfixedTonnes = totalSoldTonnes * (1 - fixedRatio);
        const sellFixedPrice = avgSellPrice - priceAdjustment;
        const sellFixedValue = sellFixedTonnes * sellFixedPrice;
        const sellUnfixedValue = totalSoldValue - sellFixedValue;
        const sellUnfixedPrice = sellUnfixedTonnes > 0 ? sellUnfixedValue/sellUnfixedTonnes : 0;
        document.getElementById('sell-fixed-qty').textContent = formatTonnes(sellFixedTonnes);
        document.getElementById('sell-unfixed-qty').textContent = formatTonnes(sellUnfixedTonnes);
        document.getElementById('sell-fixed-price').textContent = formatCurrencyPerTon(sellFixedPrice);
        document.getElementById('sell-unfixed-price').textContent = formatCurrencyPerTon(sellUnfixedPrice);
        document.getElementById('sell-fixed-total').textContent = formatCurrency(sellFixedValue);
        document.getElementById('sell-unfixed-total').textContent = formatCurrency(sellUnfixedValue);


        // Populate "Faktinė būsena"
        const actualProfit = totalSoldValue - costOfGoodsSold;
        document.getElementById('summary-sold-qty').textContent = formatTonnes(totalSoldTonnes);
        document.getElementById('summary-actual-income').textContent = formatCurrency(totalSoldValue, true);
        document.getElementById('summary-actual-cogs').textContent = formatCurrency(-costOfGoodsSold, true);
        const summaryActualProfitEl = document.getElementById('summary-actual-profit');
        summaryActualProfitEl.textContent = formatCurrency(actualProfit);
        summaryActualProfitEl.classList.toggle('text-red-600', actualProfit < 0);
        summaryActualProfitEl.classList.toggle('text-green-600', actualProfit >= 0);
        
        // Populate Projections (using TOTAL open position)
        let projectedProfit = 0;
        let projectedProfitPerTon = 0;
        const surplusBlock = document.getElementById('surplus-projection-block');
        const deficitBlock = document.getElementById('deficit-projection-block');
        const totalSurplusRow = document.getElementById('total-surplus-row');
        const totalDeficitRow = document.getElementById('total-deficit-row');

        if (totalOpenPosition >= 0) {
            surplusBlock.classList.remove('inactive-block');
            deficitBlock.classList.add('inactive-block');
            totalSurplusRow.classList.remove('hidden');
            totalDeficitRow.classList.add('hidden');
            const projectedSellPrice = parseFloat(document.getElementById('projected-sell-price').value.replace(',', '.')) || 0;
            const projectedIncome = totalOpenPosition * projectedSellPrice;
            projectedProfit = projectedIncome - totalOpenPositionValue;
            document.getElementById('surplus-open-qty').textContent = formatTonnes(totalOpenPosition);
            document.getElementById('projected-income').textContent = formatCurrency(projectedIncome, true);
            document.getElementById('projected-cogs').textContent = formatCurrency(-totalOpenPositionValue, true);
            const projectedProfitEl = document.getElementById('projected-profit');
            projectedProfitEl.textContent = formatCurrency(projectedProfit);
            projectedProfitEl.classList.toggle('text-red-600', projectedProfit < 0);
            projectedProfitEl.classList.toggle('text-green-600', projectedProfit >= 0);

            projectedProfitPerTon = totalOpenPosition !== 0 ? projectedProfit / totalOpenPosition : 0;
            const surplusProjectedProfitPerTonEl = document.getElementById('surplus-projected-profit-per-ton');
            surplusProjectedProfitPerTonEl.textContent = formatCurrencyPerTon(projectedProfitPerTon);
            surplusProjectedProfitPerTonEl.classList.toggle('text-red-600', projectedProfitPerTon < 0);
            surplusProjectedProfitPerTonEl.classList.toggle('text-green-600', projectedProfitPerTon >= 0);
            
            document.getElementById('total-summary-surplus-profit-per-ton').textContent = `(${formatCurrencyPerTon(projectedProfitPerTon)}/t)`;
            document.getElementById('total-summary-deficit-profit-per-ton').textContent = `(€0,00/t)`;
        } else {
            surplusBlock.classList.add('inactive-block');
            deficitBlock.classList.remove('inactive-block');
            totalSurplusRow.classList.add('hidden');
            totalDeficitRow.classList.remove('hidden');
            const projectedBuyPrice = parseFloat(document.getElementById('projected-buy-price').value.replace(',', '.')) || 0;
            const projectedCost = Math.abs(totalOpenPosition) * projectedBuyPrice;
            const revenueForDeficit = Math.abs(totalOpenPosition) * avgSellPrice;
            projectedProfit = revenueForDeficit - projectedCost;
            document.getElementById('deficit-open-qty').textContent = formatTonnes(Math.abs(totalOpenPosition));
            document.getElementById('deficit-income').textContent = formatCurrency(revenueForDeficit, true);
            document.getElementById('deficit-cogs').textContent = formatCurrency(-projectedCost, true);
            const deficitProfitEl = document.getElementById('deficit-profit');
            deficitProfitEl.textContent = formatCurrency(projectedProfit);
            deficitProfitEl.classList.toggle('text-red-600', projectedProfit < 0);
            deficitProfitEl.classList.toggle('text-green-600', projectedProfit >= 0);

            projectedProfitPerTon = totalOpenPosition !== 0 ? projectedProfit / Math.abs(totalOpenPosition) : 0;
            const deficitProjectedProfitPerTonEl = document.getElementById('deficit-projected-profit-per-ton');
            deficitProjectedProfitPerTonEl.textContent = formatCurrencyPerTon(projectedProfitPerTon);
            deficitProjectedProfitPerTonEl.classList.toggle('text-red-600', projectedProfitPerTon < 0);
            deficitProjectedProfitPerTonEl.classList.toggle('text-green-600', projectedProfitPerTon >= 0);
            
            document.getElementById('total-summary-deficit-profit-per-ton').textContent = `(${formatCurrencyPerTon(projectedProfitPerTon)}/t)`;
            document.getElementById('total-summary-surplus-profit-per-ton').textContent = `(€0,00/t)`;
        }
        
        // Populate final summaries
        const totalProjectedProfit = actualProfit + projectedProfit;
        const totalSummaryActualProfitEl = document.getElementById('total-summary-actual-profit');
        totalSummaryActualProfitEl.textContent = formatCurrency(actualProfit);
        totalSummaryActualProfitEl.classList.toggle('text-red-400', actualProfit < 0);
        totalSummaryActualProfitEl.classList.toggle('text-green-400', actualProfit >= 0);

        const totalSummarySurplusProfitEl = document.getElementById('total-summary-surplus-profit');
        totalSummarySurplusProfitEl.textContent = formatCurrency(totalOpenPosition >= 0 ? projectedProfit : 0, true);
        totalSummarySurplusProfitEl.classList.toggle('text-red-400', totalOpenPosition >= 0 && projectedProfit < 0);
        totalSummarySurplusProfitEl.classList.toggle('text-green-400', totalOpenPosition >= 0 && projectedProfit >= 0);
        
        const totalSummaryDeficitProfitEl = document.getElementById('total-summary-deficit-profit');
        totalSummaryDeficitProfitEl.textContent = formatCurrency(totalOpenPosition < 0 ? projectedProfit : 0, true);
        totalSummaryDeficitProfitEl.classList.toggle('text-red-400', totalOpenPosition < 0 && projectedProfit < 0);
        totalSummaryDeficitProfitEl.classList.toggle('text-green-400', totalOpenPosition < 0 && projectedProfit >= 0);

        const totalProjectedProfitEl = document.getElementById('total-projected-profit');
        totalProjectedProfitEl.textContent = formatCurrency(totalProjectedProfit);
        totalProjectedProfitEl.classList.toggle('text-red-400', totalProjectedProfit < 0);
        totalProjectedProfitEl.classList.toggle('text-green-400', totalProjectedProfit >= 0);

        // Populate averages
        const overallAvgBuyPrice = (contractData.totalPurchasedTonnes + inventoryQty) > 0 ? (contractData.totalPurchaseValue + inventoryTotalValue) / (contractData.totalPurchasedTonnes + inventoryQty) : 0;
        const actualProfitPerTon = totalSoldTonnes > 0 ? actualProfit / totalSoldTonnes : 0;
        
        document.getElementById('total-summary-actual-profit-per-ton').textContent = `(${formatCurrencyPerTon(actualProfitPerTon)}/t)`;
        
        const totalPurchasedAndInventory = contractData.totalPurchasedTonnes + inventoryQty;
        const totalProfitPerTon = totalPurchasedAndInventory > 0 ? totalProjectedProfit / totalPurchasedAndInventory : 0;
        
        document.getElementById('summary-avg-buy-price').textContent = formatCurrencyPerTon(overallAvgBuyPrice);
        document.getElementById('summary-avg-actual-sell-price').textContent = formatCurrencyPerTon(avgSellPrice);

        const summaryActualProfitPerTonEl = document.getElementById('summary-actual-profit-per-ton');
        summaryActualProfitPerTonEl.textContent = formatCurrencyPerTon(actualProfitPerTon);
        summaryActualProfitPerTonEl.classList.toggle('text-red-600', actualProfitPerTon < 0);
        summaryActualProfitPerTonEl.classList.toggle('text-green-600', actualProfitPerTon >= 0);

        const totalProfitPerTonEl = document.getElementById('summary-total-profit-per-ton');
        totalProfitPerTonEl.textContent = formatCurrencyPerTon(totalProfitPerTon);
        const totalProfitPerTonContainer = totalProfitPerTonEl.closest('.summary-row');
        if (totalProfitPerTonContainer) {
            totalProfitPerTonContainer.classList.toggle('text-red-400', totalProfitPerTon < 0);
            totalProfitPerTonContainer.classList.toggle('text-green-400', totalProfitPerTon >= 0);
        }

        renderDetailedReport(totalProfitPerTon, actualProfit);
        checkSaveButtonState();
    }
    
    function saveReport() {
        const grainSelect = document.getElementById('grain-select');
        const selectedGrain = grainSelect.value;
        const selectedGrainText = grainSelect.options[grainSelect.selectedIndex].text;
        
        const params = new URLSearchParams({
            static: true,
            grain: selectedGrain,
            grainText: selectedGrainText,
            period: document.getElementById('period-select').value,
            startDate: document.getElementById('start-date').value,
            endDate: document.getElementById('end-date').value,
            marketDate: document.getElementById('market-date').value,
            matifRapeseed: document.getElementById('matif-rapeseed').value,
            matifWheat: document.getElementById('matif-wheat').value,
            fobMalt: document.getElementById('fob-malt').value,
            inventoryQty: document.getElementById('inventory-qty').value,
            inventoryPrice: document.getElementById('inventory-price').value,
            projectedSellPrice: document.getElementById('projected-sell-price').value,
            projectedBuyPrice: document.getElementById('projected-buy-price').value,
        });

        const url = `${window.location.pathname}?${params.toString()}`;

        const now = new Date();
        const saveDate = `${now.toISOString().slice(0, 10)} ${now.toTimeString().slice(0, 5)}`;
        
        const historyEntry = {
            date: saveDate,
            grainText: selectedGrainText,
            url: url
        };

        let history = JSON.parse(localStorage.getItem('reportHistory')) || [];
        history.unshift(historyEntry);
        localStorage.setItem('reportHistory', JSON.stringify(history));

        loadHistory();
        
        const toast = document.getElementById('toast-message');
        toast.style.opacity = 1;
        setTimeout(() => {
            toast.style.opacity = 0;
        }, 3000);
    }

    function updateShareButtonState() {
        const checkboxes = document.querySelectorAll('.history-checkbox:checked');
        const shareButton = document.getElementById('share-selected-btn');
        shareButton.disabled = checkboxes.length === 0;
    }

    function loadHistory() {
        const historyList = document.getElementById('history-list');
        let history = JSON.parse(localStorage.getItem('reportHistory')) || [];

        historyList.innerHTML = '';

        if (history.length === 0) {
            historyList.innerHTML = '<p class="text-center text-gray-500 py-8">Istorijos įrašų nėra.</p>';
            return;
        }

        history.forEach((entry, index) => {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition-colors';

            const leftSide = document.createElement('div');
            leftSide.className = 'flex items-center space-x-4 flex-grow';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'history-checkbox h-5 w-5 rounded text-amber-600 focus:ring-amber-500 border-gray-300 cursor-pointer';
            checkbox.dataset.index = index;
            checkbox.addEventListener('change', updateShareButtonState);

            const linkContent = document.createElement('div');
            
            const title = document.createElement('span');
            title.className = 'font-semibold text-amber-800';
            title.textContent = entry.grainText;

            const date = document.createElement('span');
            date.className = 'text-sm text-gray-500 ml-3';
            date.textContent = `Išsaugota: ${entry.date}`;
            
            linkContent.appendChild(title);
            linkContent.appendChild(date);

            const link = document.createElement('a');
            link.href = entry.url;
            link.target = '_blank';
            link.className = 'flex-grow';
            link.appendChild(linkContent);

            leftSide.appendChild(checkbox);
            leftSide.appendChild(link);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-btn text-red-500 hover:text-red-700 font-semibold px-3 py-1 transition-colors';
            deleteButton.dataset.index = index;
            deleteButton.textContent = 'Trinti';
            deleteButton.addEventListener('click', (e) => {
                const itemIndex = parseInt(e.target.dataset.index, 10);
                history.splice(itemIndex, 1);
                localStorage.setItem('reportHistory', JSON.stringify(history));
                loadHistory(); // Re-render the list
            });

            itemContainer.appendChild(leftSide);
            itemContainer.appendChild(deleteButton);
            historyList.appendChild(itemContainer);
        });
        updateShareButtonState();
    }

    function initialize() {
        const urlParams = new URLSearchParams(window.location.search);
        const isStatic = urlParams.get('static') === 'true';

        // --- Populate Grain Select Dropdown (always) ---
        const grainSelect = document.getElementById('grain-select');
        for (const [key, value] of Object.entries(allData)) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = `${key.toUpperCase()} ${value.name}`;
            grainSelect.appendChild(option);
        }
        const allOption = document.createElement('option');
        allOption.value = 'visi';
        allOption.textContent = 'Visi';
        grainSelect.appendChild(allOption);
        grainSelect.value = state.selectedGrain; // Set default for dynamic mode

        // --- Static Mode (View-only from URL) ---
        if (isStatic) {
            const setVal = (id, param) => {
                const el = document.getElementById(id);
                if (el) el.value = urlParams.get(param) || (el.type === 'text' ? '0' : ''); // Set to 0 or empty for static view
            };
            
            setVal('grain-select', 'grain');
            setVal('period-select', 'period');
            setVal('start-date', 'startDate');
            setVal('end-date', 'endDate');
            setVal('market-date', 'marketDate');
            setVal('matif-rapeseed', 'matifRapeseed');
            setVal('matif-wheat', 'matifWheat');
            setVal('fob-malt', 'fobMalt');
            setVal('inventory-qty', 'inventoryQty');
            setVal('inventory-price', 'inventoryPrice');
            setVal('projected-sell-price', 'projectedSellPrice');
            setVal('projected-buy-price', 'projectedBuyPrice');
            
            if (document.getElementById('period-select').value === 'pasirinkti') {
                document.getElementById('date-range-picker').classList.remove('hidden');
            }

            renderDashboard();

            // Show both report panels in static mode
            document.getElementById('reports-panel').classList.remove('hidden');

            // Disable all interactions
            document.getElementById('static-mode-overlay').style.display = 'block';
            document.getElementById('tabs-nav').style.display = 'none';
             document.getElementById('save-button-container').style.display = 'none';
            document.getElementById('filters-box').style.display = 'none';
            const staticTitle = document.createElement('h2');
            staticTitle.className = 'text-center text-xl font-bold text-red-700 mb-6';
            staticTitle.textContent = 'IŠSAUGOTOS ATASKAITOS PERŽIŪRA (STATINĖ VERSIJA)';
            const header = document.querySelector('header');
            header.parentNode.insertBefore(staticTitle, header.nextSibling);

            const grainText = urlParams.get('grainText');
            const marketDateText = urlParams.get('marketDate'); // Gauname datą iš URL

            if (grainText) {
                const grainDisplay = document.createElement('h3');
                // Sumažiname apatinį atstumą, kad data būtų arčiau
                grainDisplay.className = 'text-center text-2xl font-semibold text-gray-700 mb-4';
                grainDisplay.innerHTML = `<span class="font-normal">Kultūra:</span> <span class="text-amber-800">${decodeURIComponent(grainText)}</span>`;
                staticTitle.parentNode.insertBefore(grainDisplay, staticTitle.nextSibling);

                // Sukuriame ir įterpiame datos elementą
                if (marketDateText) {
                    const dateDisplay = document.createElement('h3');
                    dateDisplay.className = 'text-center text-2xl font-semibold text-gray-700 mb-8';
                    dateDisplay.innerHTML = `<span class="font-normal">Data:</span> <span class="text-amber-800">${marketDateText}</span>`;
                    // Įterpiame po kultūros elemento
                    grainDisplay.parentNode.insertBefore(dateDisplay, grainDisplay.nextSibling);
                }
            }

            return; // Stop further initialization for static mode
        }

        // --- Dynamic Mode (Interactive) ---
        const now = new Date();
        document.getElementById('timestamp').textContent = `Duomenys atnaujinti: ${now.toISOString().slice(0, 10)} ${now.toTimeString().slice(0, 5)}`;
        
        const marketDate = document.getElementById('market-date');
        if(marketDate) marketDate.value = now.toISOString().slice(0, 10);
        
        const periodSelect = document.getElementById('period-select');
        const dateRangePicker = document.getElementById('date-range-picker');
        const shareModal = document.getElementById('share-modal');
        const shareButton = document.getElementById('share-selected-btn');
        const closeModalButton = document.getElementById('close-modal-btn');
        const sendEmailButton = document.getElementById('send-email-btn');

        const setupEventListeners = () => {
            periodSelect.addEventListener('change', (e) => {
                state.selectedPeriod = e.target.value;
                dateRangePicker.classList.toggle('hidden', e.target.value !== 'pasirinkti');
                renderDashboard();
            });

            document.getElementById('start-date').addEventListener('change', renderDashboard);
            document.getElementById('end-date').addEventListener('change', renderDashboard);
            grainSelect.addEventListener('change', renderDashboard);
            document.getElementById('projected-sell-price').addEventListener('input', renderDashboard);
            document.getElementById('projected-buy-price').addEventListener('input', renderDashboard);
            document.getElementById('inventory-qty').addEventListener('input', renderDashboard);
            document.getElementById('inventory-price').addEventListener('input', renderDashboard);
            document.getElementById('save-report-btn').addEventListener('click', saveReport);
            
            shareButton.addEventListener('click', () => {
                const history = JSON.parse(localStorage.getItem('reportHistory')) || [];
                const checkedIndexes = [...document.querySelectorAll('.history-checkbox:checked')].map(cb => parseInt(cb.dataset.index, 10));
                
                const links = checkedIndexes.map(index => {
                    const entry = history[index];
                    return `${entry.grainText} (${entry.date}): ${entry.url}`;
                }).join('\\n');

                document.getElementById('share-links').value = links;
                shareModal.classList.remove('hidden');
                shareModal.classList.add('flex');
            });

            closeModalButton.addEventListener('click', () => {
                shareModal.classList.add('hidden');
                shareModal.classList.remove('flex');
            });

            sendEmailButton.addEventListener('click', () => {
                const email = document.getElementById('share-email').value;
                const links = document.getElementById('share-links').value;
                if(email) {
                    window.location.href = `mailto:${email}?subject=Pasidalintos ataskaitos&body=${encodeURIComponent(links)}`;
                } else {
                    alert('Prašome įvesti el. pašto adresą.');
                }
            });
        };

        const setupTabs = () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = {
                'summary-tab': document.getElementById('summary-panel'),
                'details-tab': document.getElementById('reports-panel'),
                'history-tab': document.getElementById('history-panel')
            };
            const filtersBox = document.getElementById('filters-box');
            const saveButtonContainer = document.getElementById('save-button-container');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    Object.values(tabPanels).forEach(panel => panel.classList.add('hidden'));

                    button.classList.add('active');
                    tabPanels[button.id].classList.remove('hidden');

                    const isHistoryTab = button.id === 'history-tab';
                    const isDetailsTab = button.id === 'details-tab';

                    // Hide filters for 'Pamėnesiui' and 'Istorija'
                    filtersBox.classList.toggle('hidden', isHistoryTab || isDetailsTab);

                    // Hide save button ONLY for 'Istorija'
                    saveButtonContainer.classList.toggle('hidden', isHistoryTab);
                });
            });

            document.getElementById('summary-tab').classList.add('active');
        };

        setupEventListeners();
        setupTabs();
        loadHistory();
        renderDashboard();
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>

